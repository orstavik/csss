<style>
  main {
    font-family: Arial, sans-serif;
    /* background: var(--grey-98); */ /* Let CSSS handle this if needed */
    padding: 20px;
    min-height: 100vh;
    /* display: flex; */ /* Will be controlled by outerbox */
    /* flex-wrap: wrap; */
    gap: 20px;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 20px;
    width: 100%;
  }

  h2 {
    margin-top: 10px;
    margin-bottom: 10px;
    font-size: 1.5rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    width: 100%;
  }

  h3 {
    margin-top: 15px;
    margin-bottom: 5px;
    font-size: 1.1rem;
    width: 100%;
    color: #333;
  }

  .innerbox {
    width: 160px; /* Adjusted width */
    height: 60px; /* Explicit height */
    line-height: normal; /* Allow flex to center */
    /* vertical-align: middle; */ /* Not needed with flex */
    margin: 5px; /* Adjusted margin */
    padding: 10px;
    font-size: 0.9em;
    overflow-wrap: break-word;
  }

  .outerbox {
    display: flex;
    flex-direction: column;
    align-items: flex-start; /* Align items (h3, section) to the start */
    /* flex-wrap: wrap; */ /* Not needed here, section handles wrapping of innerbox */
    /* justify-content: center; */
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 100%; /* Make outerbox take full width */
    box-sizing: border-box;
  }

  .section {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* Gap between innerboxes */
    /* padding: 10px 0; */ /* Padding for section itself */
  }

  .checkerboard-bg {
    background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                      linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                      linear-gradient(45deg, transparent 75%, #ccc 75%), 
                      linear-gradient(-45deg, transparent 75%, #ccc 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
  }

</style>
<main class="
  $gradient(primary,#d41c84,red,20)
  $gradient(secondary,blue,yellow,20)
  $gradient(tertiary,red,green,20)
  $bg(#neutral100)
">
  <h1>Palette Guide (Gradient System)</h1>
  <!-- Content will be generated by script -->
</main>
<script>
  const mainElement = document.querySelector("main");

  const roles = [
    { name: "primary", baseColor: "#d41c84", onColor: "red", type: "gradient" },     // Matching user's color for primary in main
    { name: "secondary", baseColor: "blue", onColor: "yellow", type: "gradient" }, // Matching user's color for secondary in main
    { name: "tertiary", baseColor: "red", onColor: "green", type: "gradient" },  // Matching user's color for tertiary in main
    { name: "neutral", baseColor: "#777", onColor: "#fff", type: "popGradient" },         // Kept from user's revert, will not render colors now
    { name: "accent", baseColor: "#d41c84", onColor: "#fff", type: "popGradient" },        // Kept from user's revert, will not render colors now
  ];

  const percentageSteps = [0, 20, 40, 60, 80, 100]; // Reverted to 20-steps
  const alphaSteps = [20, 40, 60, 80]; // Reverted to 20-steps for alpha
  const chromaSuffixes = ["_p1", "_p2", "_b1", "_b2"];
  const midStep = 60; // Base for alpha and chroma variants

  let html = "";

  roles.forEach(role => {
    const onColorVar = role.onColor;
    // Assuming a step of 20 for the descriptive text as it's defined in the <main> tag's class
    const gradientCall = `$${role.type}(${role.name}, ${role.baseColor}, ${role.onColor}, 20)`; 

    html += `<div class="outerbox">
               <h2>Role: ${role.name} <span style="font-size: 0.7em; font-weight:normal;">(${gradientCall})</span></h2>
               <p style="font-size:0.9em; margin-bottom:10px;">OnColor: ${onColorVar}</p>`;

    // Percentage Steps
    html += `<h3>Percentage Steps</h3><div class="section">`;
    percentageSteps.forEach(step => {
      const varName = `#${role.name}${step === 0 ? '' : step}`;
      html += `<div class="innerbox $flex(cc) $border(solid,1px) $borderColor(#ccc) $bg(${varName}) $color(${onColorVar})">${varName}</div>`;
    });
    html += `</div>`;

    // Alpha Variants
    html += `<h3>Alpha Variants (on #${role.name}${midStep})</h3><div class="section checkerboard-bg">`;
    alphaSteps.forEach(alpha => {
      const varName = `#${role.name}${midStep}_a${alpha}`;
      html += `<div class="innerbox $flex(cc) $border(solid,1px) $borderColor(#ccc) $bg(${varName}) $color(${onColorVar})">${varName}</div>`;
    });
    html += `</div>`;

    // Chroma Variants (will effectively only work if $popGradient is active for the role)
    html += `<h3>Chroma Variants (on #${role.name}${midStep})</h3><div class="section">`;
    chromaSuffixes.forEach(suffix => {
      const varName = `#${role.name}${midStep}${suffix}`;
      html += `<div class="innerbox $flex(cc) $border(solid,1px) $borderColor(#ccc) $bg(${varName}) $color(${onColorVar})">${varName}</div>`;
    });
    html += `</div>`;
    
    html += `</div>`; // close outerbox
  });

  mainElement.insertAdjacentHTML("beforeend", html);

</script>
<script type="module">
  import { SheetWrapper } from "../src/engine.js";

  document.addEventListener("DOMContentLoaded", () => {
    const sheetWrapper = new SheetWrapper(document.querySelector("style").sheet);
    const mainElement = document.querySelector("main");

    // Process classes on the main element itself (for $gradient, $popGradient, $bg, etc.)
    if (mainElement && mainElement.classList) {
        mainElement.classList.forEach(clazz => {
            if (clazz.includes("$")) {
                try {
                    // console.log(`PaletteGuide: Processing class "${clazz}" on <main> element directly.`);
                    sheetWrapper.addRule(clazz, mainElement);
                } catch (er) {
                    console.warn(`CSSS Error processing class "${clazz}" on <main> element:`, er);
                }
            }
        });
    }

    // Process classes on descendant elements (dynamically added divs)
    // This will run after the main script block (which calls insertAdjacentHTML) has completed.
    mainElement.querySelectorAll('[class*="$"]').forEach(el => {
        el.classList.forEach(clazz => {
            if (clazz.includes("$")) {
                try {
                    // console.log(`PaletteGuide: Processing class "${clazz}" on descendant element:`, el);
                    sheetWrapper.addRule(clazz, el);
                } catch (er) {
                    console.warn(`CSSS Error processing class "${clazz}" on descendant:`, el, er);
                }
            }
        });
    });

    requestAnimationFrame(_ => {
        // console.log("PaletteGuide: Requesting CSSS cleanup.");
        sheetWrapper.cleanup();
    });
  });
</script>
